// <auto-generated/>
#pragma warning disable 1591
#pragma warning disable 0414
#pragma warning disable 0649
#pragma warning disable 0169

namespace EndToEndTest.Pages
{
    #line hidden
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
#nullable restore
#line 1 "C:\Users\miste\Desktop\School Stuff\CS 451 Capstone\CommerceApp\davidhoang\CommerceASPIdentity\_Imports.razor"
using System.Net.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "C:\Users\miste\Desktop\School Stuff\CS 451 Capstone\CommerceApp\davidhoang\CommerceASPIdentity\_Imports.razor"
using Microsoft.AspNetCore.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "C:\Users\miste\Desktop\School Stuff\CS 451 Capstone\CommerceApp\davidhoang\CommerceASPIdentity\_Imports.razor"
using Microsoft.AspNetCore.Components.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "C:\Users\miste\Desktop\School Stuff\CS 451 Capstone\CommerceApp\davidhoang\CommerceASPIdentity\_Imports.razor"
using Microsoft.AspNetCore.Components.Routing;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "C:\Users\miste\Desktop\School Stuff\CS 451 Capstone\CommerceApp\davidhoang\CommerceASPIdentity\_Imports.razor"
using Microsoft.AspNetCore.Components.Web;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "C:\Users\miste\Desktop\School Stuff\CS 451 Capstone\CommerceApp\davidhoang\CommerceASPIdentity\_Imports.razor"
using Microsoft.JSInterop;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "C:\Users\miste\Desktop\School Stuff\CS 451 Capstone\CommerceApp\davidhoang\CommerceASPIdentity\_Imports.razor"
using EndToEndTest;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "C:\Users\miste\Desktop\School Stuff\CS 451 Capstone\CommerceApp\davidhoang\CommerceASPIdentity\_Imports.razor"
using EndToEndTest.Shared;

#line default
#line hidden
#nullable disable
#nullable restore
#line 1 "C:\Users\miste\Desktop\School Stuff\CS 451 Capstone\CommerceApp\davidhoang\CommerceASPIdentity\Pages\Dashboard.razor"
using CsvHelper;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "C:\Users\miste\Desktop\School Stuff\CS 451 Capstone\CommerceApp\davidhoang\CommerceASPIdentity\Pages\Dashboard.razor"
using System.IO;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "C:\Users\miste\Desktop\School Stuff\CS 451 Capstone\CommerceApp\davidhoang\CommerceASPIdentity\Pages\Dashboard.razor"
using System.Globalization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "C:\Users\miste\Desktop\School Stuff\CS 451 Capstone\CommerceApp\davidhoang\CommerceASPIdentity\Pages\Dashboard.razor"
using EndToEndTest.Data.CommerceDataModels;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "C:\Users\miste\Desktop\School Stuff\CS 451 Capstone\CommerceApp\davidhoang\CommerceASPIdentity\Pages\Dashboard.razor"
using Data;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "C:\Users\miste\Desktop\School Stuff\CS 451 Capstone\CommerceApp\davidhoang\CommerceASPIdentity\Pages\Dashboard.razor"
using System.Security.Claims;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "C:\Users\miste\Desktop\School Stuff\CS 451 Capstone\CommerceApp\davidhoang\CommerceASPIdentity\Pages\Dashboard.razor"
using System.Web;

#line default
#line hidden
#nullable disable
#nullable restore
#line 10 "C:\Users\miste\Desktop\School Stuff\CS 451 Capstone\CommerceApp\davidhoang\CommerceASPIdentity\Pages\Dashboard.razor"
using Microsoft.AspNetCore.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 11 "C:\Users\miste\Desktop\School Stuff\CS 451 Capstone\CommerceApp\davidhoang\CommerceASPIdentity\Pages\Dashboard.razor"
using Microsoft.Data.SqlClient;

#line default
#line hidden
#nullable disable
#nullable restore
#line 12 "C:\Users\miste\Desktop\School Stuff\CS 451 Capstone\CommerceApp\davidhoang\CommerceASPIdentity\Pages\Dashboard.razor"
using Microsoft.AspNetCore.Components;

#line default
#line hidden
#nullable disable
#nullable restore
#line 13 "C:\Users\miste\Desktop\School Stuff\CS 451 Capstone\CommerceApp\davidhoang\CommerceASPIdentity\Pages\Dashboard.razor"
using Microsoft.AspNetCore.Components.Forms;

#line default
#line hidden
#nullable disable
#nullable restore
#line 14 "C:\Users\miste\Desktop\School Stuff\CS 451 Capstone\CommerceApp\davidhoang\CommerceASPIdentity\Pages\Dashboard.razor"
using System.Text.RegularExpressions;

#line default
#line hidden
#nullable disable
#nullable restore
#line 15 "C:\Users\miste\Desktop\School Stuff\CS 451 Capstone\CommerceApp\davidhoang\CommerceASPIdentity\Pages\Dashboard.razor"
using Microsoft.AspNetCore.Mvc;

#line default
#line hidden
#nullable disable
#nullable restore
#line 16 "C:\Users\miste\Desktop\School Stuff\CS 451 Capstone\CommerceApp\davidhoang\CommerceASPIdentity\Pages\Dashboard.razor"
using System.Runtime.Serialization.Formatters.Binary;

#line default
#line hidden
#nullable disable
#nullable restore
#line 17 "C:\Users\miste\Desktop\School Stuff\CS 451 Capstone\CommerceApp\davidhoang\CommerceASPIdentity\Pages\Dashboard.razor"
using Utils;

#line default
#line hidden
#nullable disable
    [Microsoft.AspNetCore.Components.RouteAttribute("/Dashboard")]
    [Microsoft.AspNetCore.Components.RouteAttribute("/Account")]
    public partial class Dashboard : OwningComponentBase<NotificationServices>
    {
        #pragma warning disable 1998
        protected override void BuildRenderTree(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder __builder)
        {
        }
        #pragma warning restore 1998
#nullable restore
#line 228 "C:\Users\miste\Desktop\School Stuff\CS 451 Capstone\CommerceApp\davidhoang\CommerceASPIdentity\Pages\Dashboard.razor"
       

    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; }
    List<AmountConstraint> ac;
    List<TimeConstraint> tc;
    List<LocationConstraint> lc;
    List<UserToNotifications> notifList;
    List<TriggeredNotif> triggeredList;
    List<joinAllNotifsResult> allJoinedNotifs;
    UserToNotifications tempUTN;
    //Match match = Regex.Match("")

    AmountConstraint tempAC = new AmountConstraint();
    TimeConstraint tempTC = new TimeConstraint();
    LocationConstraint tempLC = new LocationConstraint();

    private bool displayManage = false;
    private bool showFilter = false;
    private string manageDropDown => displayManage ? "d-block" : null;

    /// <summary>
    /// IMPORTANT: gets the current month and the first 3 letters as an abbreviation. This is used to get the proper monthly count in functions
    /// </summary>
    string currMonth = DateTime.Now.ToString("MMMM").Substring(0, 3);

    private int triggerCt = 0;
    private string month = DateTime.Now.ToString("MMMM").Substring(0, 3);
    private string notiff = "All notifications";

    /// <summary>
    /// Changes the bool value of "show filter" - operates the "Filter Notifications" modal.
    /// </summary>
    void openFilter()
    {
        showFilter = true;
    }

    /// <summary>
    /// Changes the bool value of "show filter" - operates the "Filter Notifications" modal.
    /// </summary>
    void closeFilter()
    {
        showFilter = false;
    }

    /// <summary>
    /// Requires an integer and sets the value of the "Triggered" count.
    /// </summary>
    /// <param name="val"></param>
    private void setTrigger(int val)
    {
        triggerCt = val;
    }

    /// <summary>
    /// Requires a string parameter (must be a notification ID or "all") and updates values within the notification summary section.
    /// </summary>
    /// <param name="idVal"></param>
    private void setNotifMess(string idVal)
    {
        if (idVal != "all")
        {
            int id = Int32.Parse(idVal);
            foreach (var x in ac)
            {
                if (id == x.NotificationId)
                {
                    notiff = "Transactions between " + "$" + x.Min + " - " + "$" + x.Max + ".";
                }
            }
            foreach (var x in lc)
            {
                if (id == x.NotificationId)
                {
                    notiff = "Transactions from " + x.Location + ".";
                }
            }
            foreach (var x in tc)
            {
                if (id == x.NotificationId)
                {
                    notiff = "Transactions between " + revertDateTime(x.TimeIn) + " - " + revertDateTime(x.TimeOut) + ".";
                }
            }
        }
        else
        {
            notiff = "All notifications";
            return;
        }
    }

    /// <summary>
    /// Function that automatically updates the notification summary section once page is loaded.
    /// </summary>
    async Task checkNotif()
    {
        if (notiff == "All notifications" && month == "Year: ")
        {
            int sum = 0;
            foreach (var x in notifList)
            {
                sum += getYearlySumOfNotif(x);
            }
            setTrigger(sum);
        }
        else if (notiff == "All notifications" && month != "Year: ")
        {
            int total = 0;
            foreach (var x in notifList)
            {
                total += Int32.Parse(@x.GetType().GetProperty(month).GetValue(x).ToString());
            }
            setTrigger(total);
        }
    }

    /// <summary>
    /// Function that gets called whenever a user selects values to filter the notification summary section.
    /// </summary>
    /// <param name="changeEventArgs"></param>
    public void FilterSearch(ChangeEventArgs changeEventArgs)
    {
        showFilter = false;
        string notifID = changeEventArgs.Value.ToString();
        setNotifMess(notifID);
        if (notiff == "All notifications" && month == "Year: ")
        {
            int sum = 0;
            foreach (var x in notifList)
            {
                sum += getYearlySumOfNotif(x);
            }
            setTrigger(sum);
        }
        else if(notiff == "All notifications" && month != "Year: ")
        {
            int total = 0;
            foreach (var x in notifList)
            {
                total += Int32.Parse(@x.GetType().GetProperty(month).GetValue(x).ToString());
            }
            setTrigger(total);
        }
        else
        {
            int convID = Int32.Parse(notifID);
            foreach (var y in notifList)
            {
                if (convID == y.NotificationId)
                {
                    if (month == "Year: ")
                    {
                        setTrigger(Int32.Parse(getYearlySumOfNotif(y).ToString()));

                    }
                    else
                    {
                        setTrigger(Int32.Parse(@y.GetType().GetProperty(month).GetValue(y).ToString()));
                    }

                }
            }
        }
    }

    /// <summary>
    /// Prepares the page and its variables on load. Since it is async, things will be null for a bit.
    /// </summary>
    /// <returns></returns>
    protected override async Task OnInitializedAsync()
    {
        var user = (await AuthenticationStateProvider.GetAuthenticationStateAsync()).User;
        string userId = user.FindFirst(c => c.Type.Contains("nameidentifier"))?.Value;

        notifList = await Service.GetNotifJoinTable(userId);
        triggeredList = await Service.GetAllTriggeredNotifEntries(user.Identity.Name);
        ac = await Service.GetAmountConstraints(notifList);
        tc = await Service.GetTimeConstraints(notifList);
        lc = await Service.GetLocationConstraints(notifList);
        await getAllNotifsJoinedWithMonthsAsync();
        await checkNotif();
    }

    /// <summary>
    /// Returns the total count of notification rules.
    /// </summary>
    /// <returns></returns>
    int returnCount()
    {
        int counter = 0;
        if (ac != null)
        {
            counter += ac.Count;
        }
        if (lc != null)
        {
            counter += lc.Count;
        }
        if (tc != null)
        {
            counter += tc.Count;
        }
        return counter;
    }

    /// <summary>
    /// Requires a TimeSpan. Converts the TimeSpan and outputs a string.
    /// </summary>
    /// <param name="theDateTime"></param>
    /// <returns></returns>
    string revertDateTime(TimeSpan theDateTime)
    {
        DateTime time = DateTime.Today.Add(theDateTime);
        string convertedTime = time.ToString("h:mm tt");
        return convertedTime;
    }

    /// <summary>
    /// Function that toggles the Manage button.
    /// </summary>
    private void ToggleManageDropDown()
    {
        displayManage = !displayManage;
    }

    /// <summary>
    /// Returns the string as pure HTML from the database to render in page
    /// </summary>
    /// <param name="text"></param>
    /// <returns></returns>
    public MarkupString getHTMLMarkup(string text)
    {
        return (MarkupString)text;
    }

    /// <summary>
    /// Gets the yearly sum of the notification passed in.
    /// </summary>
    /// <param name="notif"></param>
    /// <returns></returns>
    public int getYearlySumOfNotif(UserToNotifications notif)
    {
        return notif.Jan
        + notif.Feb
        + notif.Mar
        + notif.Apr
        + notif.May
        + notif.Jun
        + notif.Jul
        + notif.Aug
        + notif.Sep
        + notif.Oct
        + notif.Nov
        + notif.Dec;
    }

    public int getIndexOfSubstring(string text, string toMatch)
    {
        return text.IndexOf(toMatch);
    }

    /// <summary>
    /// Async gets all the user's notifications joined with months.
    /// </summary>
    /// <returns></returns>
    async Task getAllNotifsJoinedWithMonthsAsync()
    {
        var user = (await AuthenticationStateProvider.GetAuthenticationStateAsync()).User;
        string userId = user.FindFirst(c => c.Type.Contains("nameidentifier"))?.Value;
        allJoinedNotifs = await Service.getAllNotifsJoinedWithDates(userId);
    }



#line default
#line hidden
#nullable disable
#nullable restore
#line 505 "C:\Users\miste\Desktop\School Stuff\CS 451 Capstone\CommerceApp\davidhoang\CommerceASPIdentity\Pages\Dashboard.razor"
           

    async Task DownloadFile()
    {
        using var memorystream = new MemoryStream();
        using var writer = new StreamWriter(memorystream);
        //using var writer = new StreamWriter("../export.csv");
        using var csv = new CsvWriter(writer, CultureInfo.InvariantCulture);
        {
            csv.WriteRecords(allJoinedNotifs);
            writer.Flush();
        }
        string filename = "monthly_notif_trigger_export_" + DateTime.Now.ToString("yyyy") + ".csv";
        //var bytes = System.Text.Encoding.UTF8.GetBytes(text);
        //await FileUtils.SaveAs(js, "export.csv", memorystream.ToArray());
        //var result = writer.ToString();
        //Console.WriteLine(result);
        await Service.SaveAs(js, filename, memorystream.ToArray());
    }

#line default
#line hidden
#nullable disable
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IJSRuntime js { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private NavigationManager navManager { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IHttpContextAccessor HttpContextAccessor { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private AuthenticationStateProvider AuthenticationStateProvider { get; set; }
    }
}
#pragma warning restore 1591
